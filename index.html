<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna's Make Up - Gestión</title>
    <!-- CDN oficial de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 50%, #e1bee7 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(233, 30, 99, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h2 {
            color: #e91e63;
            margin-bottom: 20px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            border: 3px solid #e91e63;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: #ad1457;
            font-weight: bold;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #f8bbd9;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-form input:focus {
            outline: none;
            border-color: #e91e63;
            box-shadow: 0 0 10px rgba(233, 30, 99, 0.3);
        }

        .login-btn {
            background: linear-gradient(45deg, #e91e63, #f06292);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }

        .login-error {
            color: #f44336;
            margin-top: 10px;
            display: none;
        }

        .app-container {
            display: none;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(233, 30, 99, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-container {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            border: 3px solid #e91e63;
        }

        .header h1 {
            color: #e91e63;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #ad1457;
            font-size: 1.2em;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.2);
            display: none;
        }

        .config-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.9);
            color: #e91e63;
            border: 2px solid #e91e63;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e91e63;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }

        .nav-tab.active {
            background: #e91e63;
            color: white;
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(233, 30, 99, 0.2);
            border: 1px solid rgba(233, 30, 99, 0.1);
        }

        .card h3 {
            color: #e91e63;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #f8bbd9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #e91e63;
            box-shadow: 0 0 10px rgba(233, 30, 99, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #e91e63, #f06292);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f8bbd9, #fce4ec);
            color: #e91e63;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #e57373);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #81C784);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ad1457;
            font-weight: bold;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f8bbd9;
            white-space: nowrap;
        }

        .table th {
            background: #fce4ec;
            color: #e91e63;
            font-weight: bold;
        }

        .table tbody tr:hover {
            background: #fce4ec;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fce4ec 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.2);
        }

        .stat-card i {
            font-size: 2em;
            color: #e91e63;
            margin-bottom: 10px;
        }

        .stat-card h4 {
            color: #ad1457;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #e91e63;
        }

        .stat-card .value.negative {
            color: #f44336;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .time-filter-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #e91e63;
            border: 2px solid #e91e63;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .time-filter-btn:hover {
            background: #e91e63;
            color: white;
        }

        .time-filter-btn.active {
            background: #e91e63;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #e91e63;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #e91e63;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .config-form {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-tab {
                width: 100%;
                text-align: center;
            }
            
            .table {
                display: block;
                overflow-x: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-logo">
            <img src="logo.jpg" alt="Luna's Make Up Logo">
        </div>
        <h2>Iniciar Sesión</h2>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="username">Usuario</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" required>
            </div>
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Usuario o contraseña incorrectos
            </div>
            <button type="submit" class="login-btn">Ingresar</button>
        </form>
    </div>

    <!-- Aplicación principal (oculta inicialmente) -->
    <div class="app-container" id="appContainer">
        <div class="connection-status" id="connectionStatus">
            <i class="fas fa-circle"></i> Desconectado
        </div>

        <div class="container">
            <div class="header">
                <div class="logo-container">
                    <img src="logo.jpg" alt="Luna's Make Up Logo" id="logoImg">
                </div>
                <h1>¡Bievenida!</h1>
                <p>Al sisteema de gestio de Luna´s Make Up</p>
            </div>

            <!-- Configuración de Supabase (oculta) -->
            <div class="config-section" id="configSection">
                <h3><i class="fas fa-cog"></i> Configuración de Base de Datos</h3>
                <div class="config-form">
                    <input type="text" id="supabaseUrl" placeholder="URL de Supabase">
                    <input type="password" id="supabaseKey" placeholder="Clave anónima de Supabase">
                    <button class="btn" onclick="connectSupabase()">Conectar</button>
                </div>
            </div>

            <!-- Navegación -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showTab('dashboard')">
                    <i class="fas fa-chart-pie"></i> Dashboard
                </div>
                <div class="nav-tab" onclick="showTab('productos')">
                    <i class="fas fa-box"></i> Productos
                </div>
                <div class="nav-tab" onclick="showTab('ventas')">
                    <i class="fas fa-shopping-cart"></i> Ventas
                </div>
                <div class="nav-tab" onclick="showTab('costos')">
                    <i class="fas fa-receipt"></i> Costos
                </div>
                <div class="nav-tab" onclick="showTab('clientes')">
                    <i class="fas fa-users"></i> Clientes
                </div>
                <div class="nav-tab" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h3><i class="fas fa-filter"></i> Filtros de Tiempo</h3>
                    <div class="time-filter">
                        <button class="time-filter-btn active" onclick="changeTimeFilter('hoy')">Hoy</button>
                        <button class="time-filter-btn" onclick="changeTimeFilter('semana')">Esta Semana</button>
                        <button class="time-filter-btn" onclick="changeTimeFilter('mes')">Este Mes</button>
                        <button class="time-filter-btn" onclick="changeTimeFilter('total')">Total</button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <!-- Primera fila: Ventas y Costos -->
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign"></i>
                        <h4>Ventas Brutas</h4>
                        <div class="value" id="ventasBrutasPeriodo">$0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-receipt"></i>
                        <h4>Costos Totales</h4>
                        <div class="value" id="costosPeriodo">$0</div>
                    </div>
                    
                    <!-- Segunda fila: Ganancias -->
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <h4>Ganancia Bruta</h4>
                        <div class="value" id="gananciaBrutaPeriodo">$0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-money-bill-wave"></i>
                        <h4>Ganancia Neta</h4>
                        <div class="value" id="gananciaNetaPeriodo">$0</div>
                    </div>
                    
                    <!-- Tercera fila: Inventario y Clientes -->
                    <div class="stat-card">
                        <i class="fas fa-box"></i>
                        <h4>Total Productos</h4>
                        <div class="value" id="totalProductos">0</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h4>Total Clientes</h4>
                        <div class="value" id="totalClientes">0</div>
                    </div>
                    
                    <!-- Cuarta fila: Deudas -->
                    <div class="stat-card">
                        <i class="fas fa-money-bill-alt"></i>
                        <h4>Deudas Pendientes</h4>
                        <div class="value" id="totalDeudas">$0</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-chart-bar"></i> Resumen de Ventas</h3>
                    <div class="chart-container">
                        <canvas id="ventasChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-chart-pie"></i> Distribución de Costos</h3>
                    <div class="chart-container">
                        <canvas id="costosChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div id="productos" class="tab-content">
                <div class="card">
                    <h3><i class="fas fa-plus"></i> Agregar Producto</h3>
                    <form id="productoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre del Producto</label>
                                <input type="text" id="productoNombre" required>
                            </div>
                            <div class="form-group">
                                <label>Costo</label>
                                <input type="number" step="0.01" id="productoCosto" required>
                            </div>
                            <div class="form-group">
                                <label>Precio de Venta</label>
                                <input type="number" step="0.01" id="productoPrecio" required>
                            </div>
                            <div class="form-group">
                                <label>Stock Inicial</label>
                                <input type="number" id="productoStock" value="0">
                            </div>
                        </div>
                        <button type="submit" class="btn">Agregar Producto</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-list"></i> Lista de Productos</h3>
                    <table class="table" id="productosTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Costo</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Vendidos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Ventas -->
            <div id="ventas" class="tab-content">
                <div class="card">
                    <h3><i class="fas fa-plus"></i> Registrar Venta</h3>
                    <form id="ventaForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Producto</label>
                                <select id="ventaProducto" required>
                                    <option value="">Seleccionar producto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="ventaCantidad" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Cliente (opcional)</label>
                                <select id="ventaCliente">
                                    <option value="">Seleccionar cliente</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="ventaFecha" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">Registrar Venta</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-list"></i> Historial de Ventas</h3>
                    <table class="table" id="ventasTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Total</th>
                                <th>Ganancia</th>
                                <th>Cliente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Costos -->
            <div id="costos" class="tab-content">
                <div class="card">
                    <h3><i class="fas fa-plus"></i> Registrar Costo</h3>
                    <form id="costoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Concepto</label>
                                <input type="text" id="costoConcepto" required>
                            </div>
                            <div class="form-group">
                                <label>Monto</label>
                                <input type="number" step="0.01" id="costoMonto" required>
                            </div>
                            <div class="form-group">
                                <label>Categoría</label>
                                <select id="costoCategoria" required>
                                    <option value="">Seleccionar categoría</option>
                                    <option value="Materiales">Materiales</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Envío">Envío</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="costoFecha" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">Registrar Costo</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-list"></i> Lista de Costos</h3>
                    <table class="table" id="costosTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th>Monto</th>
                                <th>Categoría</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Clientes -->
            <div id="clientes" class="tab-content">
                <div class="card">
                    <h3><i class="fas fa-plus"></i> Agregar Cliente</h3>
                    <form id="clienteForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre</label>
                                <input type="text" id="clienteNombre" required>
                            </div>
                            <div class="form-group">
                                <label>Deuda Inicial</label>
                                <input type="number" step="0.01" id="clienteDeuda" value="0">
                            </div>
                            <div class="form-group">
                                <label>Contacto</label>
                                <input type="text" id="clienteContacto">
                            </div>
                        </div>
                        <button type="submit" class="btn">Agregar Cliente</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-list"></i> Lista de Clientes</h3>
                    <table class="table" id="clientesTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Deuda</th>
                                <th>Contacto</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para edición -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Editar Registro</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn" id="modalSaveBtn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para confirmación -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar Acción</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="confirmBody">
                ¿Estás seguro de que deseas eliminar este registro?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        // 1. DECLARACIÓN DE VARIABLES GLOBALES
        let supabase;
        let isConnected = false;
        const supabaseUrl = 'https://asmrpqioclbpayruzdme.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzbXJwcWlvY2xicGF5cnV6ZG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MjUwMzMsImV4cCI6MjA2NzAwMTAzM30.xSFpvaylhrjhVxfwCZ2n5Ise4ZrEiZzz_l2DrqPckVI';
        let currentTimeFilter = 'hoy';
        let currentEditId = null;
        let currentEditTable = null;
        let ventasChart = null;
        let costosChart = null;
        const CORRECT_USERNAME = 'Lunita';
        const CORRECT_PASSWORD = 'amoaminovio';

        // 2. MANEJO DEL LOGIN
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            
            if (username === CORRECT_USERNAME && password === CORRECT_PASSWORD) {
                // Login exitoso
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initializeApp();
            } else {
                // Login fallido
                errorElement.style.display = 'block';
            }
        });

        function logout() {
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
        }

        function initializeApp() {
            try {
                // Inicializar Supabase
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                // Probar conexión con una consulta simple
                const { data, error } = supabase
                    .from('productos')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                isConnected = true;
                updateConnectionStatus();
                showAlert('¡Conectado exitosamente a Supabase!', 'success');
                
                // Configurar fechas y cargar datos
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('ventaFecha').value = today;
                document.getElementById('costoFecha').value = today;
                document.getElementById('configSection').style.display = 'none';
                
                loadData();
                
                // Configurar eventos de los modales
                document.getElementById('modalSaveBtn').addEventListener('click', saveEdit);
                document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
                
            } catch (error) {
                console.error('Error al conectar con Supabase:', error);
                showAlert('Error al conectar con Supabase: ' + error.message, 'error');
                isConnected = false;
                updateConnectionStatus();
            }
        }

        // 3. FUNCIÓN DE ACTUALIZACIÓN DE ESTADO DE CONEXIÓN
        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            if (isConnected) {
                status.className = 'connection-status connected';
                status.innerHTML = '<i class="fas fa-circle"></i> Conectado';
            } else {
                status.className = 'connection-status disconnected';
                status.innerHTML = '<i class="fas fa-circle"></i> Desconectado';
            }
        }

        // 4. FUNCIÓN PARA MOSTRAR ALERTAS
        function showAlert(message, type) {
            // Limpiar alertas anteriores
            const oldAlerts = document.querySelectorAll('.alert');
            oldAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
                ${message}
            `;
            
            const container = document.querySelector('.container');
            if (container.firstChild) {
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                container.appendChild(alertDiv);
            }
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // 5. FUNCIÓN PARA CAMBIAR PESTAÑAS
        function showTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Quitar clase active de todos los botones
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Cargar datos si es necesario
            if (isConnected) {
                loadData();
                
                // Redibujar gráficos si estamos en el dashboard
                if (tabName === 'dashboard') {
                    updateCharts();
                }
            }
        }

        // 6. CAMBIAR FILTRO DE TIEMPO EN DASHBOARD
        function changeTimeFilter(filter) {
            currentTimeFilter = filter;
            
            // Actualizar botones activos
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDashboard();
        }

        // 7. CARGAR DATOS GENERALES
        async function loadData() {
            if (!isConnected || !supabase) {
                showAlert('No conectado a Supabase', 'error');
                return;
            }
            
            try {
                await Promise.all([
                    loadProductos(),
                    loadVentas(),
                    loadCostos(),
                    loadClientes(),
                    updateDashboard()
                ]);
            } catch (error) {
                console.error('Error cargando datos:', error);
                showAlert('Error al cargar datos: ' + error.message, 'error');
            }
        }

        // 8. ACTUALIZAR DASHBOARD
        async function updateDashboard() {
            if (!supabase) return;

            try {
                // Obtener fechas según el filtro
                let startDate, endDate;
                const today = new Date();
                
                switch(currentTimeFilter) {
                    case 'hoy':
                        startDate = today.toISOString().split('T')[0];
                        endDate = startDate;
                        break;
                    case 'semana':
                        const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                        startDate = firstDayOfWeek.toISOString().split('T')[0];
                        endDate = new Date().toISOString().split('T')[0];
                        break;
                    case 'mes':
                        startDate = new Date().toISOString().slice(0, 7) + '-01';
                        endDate = new Date().toISOString().split('T')[0];
                        break;
                    case 'total':
                        startDate = '1970-01-01';
                        endDate = '2100-12-31';
                        break;
                }

                // Total productos
                const { data: productos } = await supabase.from('productos').select('*');
                document.getElementById('totalProductos').textContent = productos?.length || 0;

                // Ventas del periodo
                const { data: ventasPeriodo } = await supabase
                    .from('ventas')
                    .select('total, ganancia')
                    .gte('fecha', startDate)
                    .lte('fecha', endDate);
                
                const totalVentas = ventasPeriodo?.reduce((sum, venta) => sum + parseFloat(venta.total), 0) || 0;
                const totalGananciasBrutas = ventasPeriodo?.reduce((sum, venta) => sum + parseFloat(venta.ganancia), 0) || 0;
                
                document.getElementById('ventasBrutasPeriodo').textContent = `$${totalVentas.toFixed(2)}`;
                document.getElementById('gananciaBrutaPeriodo').textContent = `$${totalGananciasBrutas.toFixed(2)}`;

                // Costos del periodo
                const { data: costosPeriodo } = await supabase
                    .from('costos')
                    .select('monto')
                    .gte('fecha', startDate)
                    .lte('fecha', endDate);
                
                const totalCostos = costosPeriodo?.reduce((sum, costo) => sum + parseFloat(costo.monto), 0) || 0;
                document.getElementById('costosPeriodo').textContent = `$${totalCostos.toFixed(2)}`;

                // Calcular ganancia neta
                const gananciaNeta = totalGananciasBrutas - totalCostos;
                const gananciaNetaElement = document.getElementById('gananciaNetaPeriodo');
                gananciaNetaElement.textContent = `$${Math.abs(gananciaNeta).toFixed(2)}`;
                
                // Cambiar color si es pérdida
                if (gananciaNeta < 0) {
                    gananciaNetaElement.classList.add('negative');
                } else {
                    gananciaNetaElement.classList.remove('negative');
                }

                // Total clientes y deudas
                const { data: clientes } = await supabase.from('clientes').select('*');
                document.getElementById('totalClientes').textContent = clientes?.length || 0;
                
                const totalDeudas = clientes?.reduce((sum, cliente) => sum + parseFloat(cliente.deuda), 0) || 0;
                document.getElementById('totalDeudas').textContent = `$${totalDeudas.toFixed(2)}`;

                // Actualizar gráficos
                updateCharts();
                
            } catch (error) {
                console.error('Error actualizando dashboard:', error);
                showAlert('Error al actualizar dashboard: ' + error.message, 'error');
            }
        }

        // 9. ACTUALIZAR GRÁFICOS
        async function updateCharts() {
            if (!supabase) return;

            try {
                // Obtener datos para los gráficos
                const { data: ventas } = await supabase
                    .from('ventas')
                    .select('fecha, total')
                    .order('fecha', { ascending: true });
                
                const { data: costos } = await supabase
                    .from('costos')
                    .select('categoria, monto');
                
                // Procesar datos para el gráfico de ventas
                const ventasPorFecha = {};
                ventas?.forEach(venta => {
                    const fecha = venta.fecha;
                    ventasPorFecha[fecha] = (ventasPorFecha[fecha] || 0) + parseFloat(venta.total);
                });
                
                const fechas = Object.keys(ventasPorFecha);
                const montosVentas = Object.values(ventasPorFecha);
                
                // Procesar datos para el gráfico de costos
                const costosPorCategoria = {};
                costos?.forEach(costo => {
                    const categoria = costo.categoria;
                    costosPorCategoria[categoria] = (costosPorCategoria[categoria] || 0) + parseFloat(costo.monto);
                });
                
                const categorias = Object.keys(costosPorCategoria);
                const montosCostos = Object.values(costosPorCategoria);
                
                // Colores para los gráficos
                const colores = [
                    '#e91e63', '#f06292', '#f8bbd0', '#fce4ec',
                    '#9c27b0', '#ba68c8', '#d1c4e9', '#ede7f6',
                    '#673ab7', '#9575cd', '#b39ddb', '#d1c4e9'
                ];
                
                // Crear o actualizar gráfico de ventas
                const ventasCtx = document.getElementById('ventasChart').getContext('2d');
                if (ventasChart) {
                    ventasChart.destroy();
                }
                
                ventasChart = new Chart(ventasCtx, {
                    type: 'bar',
                    data: {
                        labels: fechas,
                        datasets: [{
                            label: 'Ventas por día',
                            data: montosVentas,
                            backgroundColor: colores[0],
                            borderColor: colores[1],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return '$' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Crear o actualizar gráfico de costos
                const costosCtx = document.getElementById('costosChart').getContext('2d');
                if (costosChart) {
                    costosChart.destroy();
                }
                
                costosChart = new Chart(costosCtx, {
                    type: 'pie',
                    data: {
                        labels: categorias,
                        datasets: [{
                            data: montosCostos,
                            backgroundColor: colores.slice(0, categorias.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error actualizando gráficos:', error);
            }
        }

        // 10. MANEJO DE PRODUCTOS
        document.getElementById('productoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) {
                showAlert('Error de conexión con Supabase', 'error');
                return;
            }

            const nombre = document.getElementById('productoNombre').value;
            const costo = parseFloat(document.getElementById('productoCosto').value);
            const precio = parseFloat(document.getElementById('productoPrecio').value);
            const stock = parseInt(document.getElementById('productoStock').value);

            try {
                const { error } = await supabase
                    .from('productos')
                    .insert([{ nombre, costo, precio, stock }]);

                if (error) throw error;

                showAlert('Producto agregado exitosamente', 'success');
                document.getElementById('productoForm').reset();
                loadProductos();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al agregar producto: ' + error.message, 'error');
            }
        });

        async function loadProductos() {
            if (!supabase) return;

            try {
                const { data: productos, error } = await supabase
                    .from('productos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.querySelector('#productosTable tbody');
                tbody.innerHTML = '';

                // Actualizar select de ventas
                const ventaSelect = document.getElementById('ventaProducto');
                ventaSelect.innerHTML = '<option value="">Seleccionar producto</option>';

                productos?.forEach(producto => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${producto.nombre}</td>
                        <td>$${producto.costo.toFixed(2)}</td>
                        <td>$${producto.precio.toFixed(2)}</td>
                        <td>${producto.stock}</td>
                        <td>${producto.vendidos || 0}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editarRegistro('productos', ${producto.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmarEliminacion('productos', ${producto.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    `;

                    // Agregar al select de ventas
                    if (producto.stock > 0) {
                        const option = document.createElement('option');
                        option.value = producto.id;
                        option.textContent = `${producto.nombre} (Stock: ${producto.stock})`;
                        option.dataset.precio = producto.precio;
                        option.dataset.costo = producto.costo;
                        ventaSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error cargando productos:', error);
                showAlert('Error al cargar productos: ' + error.message, 'error');
            }
        }

        // 11. MANEJO DE VENTAS
        document.getElementById('ventaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) {
                showAlert('Error de conexión con Supabase', 'error');
                return;
            }

            const productoId = document.getElementById('ventaProducto').value;
            const cantidad = parseInt(document.getElementById('ventaCantidad').value);
            const cliente = document.getElementById('ventaCliente').value;
            const fecha = document.getElementById('ventaFecha').value;

            if (!productoId) {
                showAlert('Selecciona un producto', 'error');
                return;
            }

            try {
                // Obtener datos del producto
                const { data: producto, error: prodError } = await supabase
                    .from('productos')
                    .select('*')
                    .eq('id', productoId)
                    .single();

                if (prodError) throw prodError;

                if (producto.stock < cantidad) {
                    showAlert('Stock insuficiente', 'error');
                    return;
                }

                const precioUnitario = producto.precio;
                const total = precioUnitario * cantidad;
                const ganancia = (precioUnitario - producto.costo) * cantidad;

                // Registrar venta
                const { error: ventaError } = await supabase
                    .from('ventas')
                    .insert([{
                        producto_id: productoId,
                        producto_nombre: producto.nombre,
                        cantidad,
                        precio_unitario: precioUnitario,
                        total,
                        ganancia,
                        cliente: cliente || null,
                        fecha
                    }]);

                if (ventaError) throw ventaError;

                // Actualizar stock y vendidos
                const { error: updateError } = await supabase
                    .from('productos')
                    .update({
                        stock: producto.stock - cantidad,
                        vendidos: (producto.vendidos || 0) + cantidad
                    })
                    .eq('id', productoId);

                if (updateError) throw updateError;

                showAlert('Venta registrada exitosamente', 'success');
                document.getElementById('ventaForm').reset();
                document.getElementById('ventaFecha').value = new Date().toISOString().split('T')[0];
                loadProductos();
                loadVentas();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al registrar venta: ' + error.message, 'error');
            }
        });

        async function loadVentas() {
            if (!supabase) return;

            try {
                const { data: ventas, error } = await supabase
                    .from('ventas')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.querySelector('#ventasTable tbody');
                tbody.innerHTML = '';

                ventas?.forEach(venta => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${venta.fecha}</td>
                        <td>${venta.producto_nombre}</td>
                        <td>${venta.cantidad}</td>
                        <td>$${venta.precio_unitario.toFixed(2)}</td>
                        <td>$${venta.total.toFixed(2)}</td>
                        <td>$${venta.ganancia.toFixed(2)}</td>
                        <td>${venta.cliente || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-danger btn-sm" onclick="confirmarEliminacion('ventas', ${venta.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error cargando ventas:', error);
                showAlert('Error al cargar ventas: ' + error.message, 'error');
            }
        }

        // 12. MANEJO DE COSTOS
        document.getElementById('costoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) {
                showAlert('Error de conexión con Supabase', 'error');
                return;
            }

            const concepto = document.getElementById('costoConcepto').value;
            const monto = parseFloat(document.getElementById('costoMonto').value);
            const categoria = document.getElementById('costoCategoria').value;
            const fecha = document.getElementById('costoFecha').value;

            try {
                const { error } = await supabase
                    .from('costos')
                    .insert([{ concepto, monto, categoria, fecha }]);

                if (error) throw error;

                showAlert('Costo registrado exitosamente', 'success');
                document.getElementById('costoForm').reset();
                document.getElementById('costoFecha').value = new Date().toISOString().split('T')[0];
                loadCostos();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al registrar costo: ' + error.message, 'error');
            }
        });

        async function loadCostos() {
            if (!supabase) return;

            try {
                const { data: costos, error } = await supabase
                    .from('costos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.querySelector('#costosTable tbody');
                tbody.innerHTML = '';

                costos?.forEach(costo => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${costo.fecha}</td>
                        <td>${costo.concepto}</td>
                        <td>$${costo.monto.toFixed(2)}</td>
                        <td>${costo.categoria}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editarRegistro('costos', ${costo.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmarEliminacion('costos', ${costo.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error cargando costos:', error);
                showAlert('Error al cargar costos: ' + error.message, 'error');
            }
        }

        // 13. MANEJO DE CLIENTES
        document.getElementById('clienteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!supabase) {
                showAlert('Error de conexión con Supabase', 'error');
                return;
            }

            const nombre = document.getElementById('clienteNombre').value;
            const deuda = parseFloat(document.getElementById('clienteDeuda').value) || 0;
            const contacto = document.getElementById('clienteContacto').value;

            try {
                const { error } = await supabase
                    .from('clientes')
                    .insert([{ nombre, deuda, contacto }]);

                if (error) throw error;

                showAlert('Cliente agregado exitosamente', 'success');
                document.getElementById('clienteForm').reset();
                loadClientes();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al agregar cliente: ' + error.message, 'error');
            }
        });

        async function loadClientes() {
            if (!supabase) return;

            try {
                const { data: clientes, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.querySelector('#clientesTable tbody');
                tbody.innerHTML = '';

                // Actualizar select de ventas
                const ventaSelect = document.getElementById('ventaCliente');
                ventaSelect.innerHTML = '<option value="">Seleccionar cliente</option>';

                clientes?.forEach(cliente => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${cliente.nombre}</td>
                        <td>$${cliente.deuda.toFixed(2)}</td>
                        <td>${cliente.contacto || '-'}</td>
                        <td>${new Date(cliente.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editarRegistro('clientes', ${cliente.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-success btn-sm" onclick="pagarDeuda(${cliente.id}, ${cliente.deuda})" ${cliente.deuda <= 0 ? 'disabled' : ''}>
                                    <i class="fas fa-money-bill-wave"></i> Pagar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmarEliminacion('clientes', ${cliente.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    `;

                    // Agregar al select de ventas
                    const option = document.createElement('option');
                    option.value = cliente.nombre;
                    option.textContent = cliente.nombre;
                    ventaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando clientes:', error);
                showAlert('Error al cargar clientes: ' + error.message, 'error');
            }
        }

        // 14. FUNCIÓN PARA PAGAR DEUDA DE CLIENTE
        async function pagarDeuda(clienteId, deudaActual) {
            if (!confirm(`¿Marcar como pagada la deuda de $${deudaActual.toFixed(2)}?`)) return;
            
            try {
                const { error } = await supabase
                    .from('clientes')
                    .update({ deuda: 0 })
                    .eq('id', clienteId);
                
                if (error) throw error;
                
                showAlert('Deuda marcada como pagada', 'success');
                loadClientes();
                updateDashboard();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al pagar deuda: ' + error.message, 'error');
            }
        }

        // 15. FUNCIONES PARA EDITAR REGISTROS
        async function editarRegistro(tabla, id) {
            currentEditId = id;
            currentEditTable = tabla;
            
            try {
                const { data: registro, error } = await supabase
                    .from(tabla)
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Configurar el modal según la tabla
                document.getElementById('modalTitle').textContent = `Editar ${tabla}`;
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = '';
                
                if (tabla === 'productos') {
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="editNombre" value="${registro.nombre}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Costo</label>
                            <input type="number" step="0.01" id="editCosto" value="${registro.costo}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Precio</label>
                            <input type="number" step="0.01" id="editPrecio" value="${registro.precio}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Stock</label>
                            <input type="number" id="editStock" value="${registro.stock}" class="form-control" required>
                        </div>
                    `;
                } else if (tabla === 'costos') {
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label>Concepto</label>
                            <input type="text" id="editConcepto" value="${registro.concepto}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Monto</label>
                            <input type="number" step="0.01" id="editMonto" value="${registro.monto}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Categoría</label>
                            <select id="editCategoria" class="form-control" required>
                                <option value="Materiales" ${registro.categoria === 'Materiales' ? 'selected' : ''}>Materiales</option>
                                <option value="Marketing" ${registro.categoria === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Envío" ${registro.categoria === 'Envío' ? 'selected' : ''}>Envío</option>
                                <option value="Otros" ${registro.categoria === 'Otros' ? 'selected' : ''}>Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="editFecha" value="${registro.fecha}" class="form-control" required>
                        </div>
                    `;
                } else if (tabla === 'clientes') {
                    modalBody.innerHTML = `
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="editNombre" value="${registro.nombre}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Deuda</label>
                            <input type="number" step="0.01" id="editDeuda" value="${registro.deuda}" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Contacto</label>
                            <input type="text" id="editContacto" value="${registro.contacto || ''}" class="form-control">
                        </div>
                    `;
                }
                
                // Mostrar modal
                document.getElementById('editModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar datos para edición: ' + error.message, 'error');
            }
        }

        async function saveEdit() {
            if (!currentEditId || !currentEditTable) return;
            
            try {
                let updateData = {};
                
                if (currentEditTable === 'productos') {
                    updateData = {
                        nombre: document.getElementById('editNombre').value,
                        costo: parseFloat(document.getElementById('editCosto').value),
                        precio: parseFloat(document.getElementById('editPrecio').value),
                        stock: parseInt(document.getElementById('editStock').value)
                    };
                } else if (currentEditTable === 'costos') {
                    updateData = {
                        concepto: document.getElementById('editConcepto').value,
                        monto: parseFloat(document.getElementById('editMonto').value),
                        categoria: document.getElementById('editCategoria').value,
                        fecha: document.getElementById('editFecha').value
                    };
                } else if (currentEditTable === 'clientes') {
                    updateData = {
                        nombre: document.getElementById('editNombre').value,
                        deuda: parseFloat(document.getElementById('editDeuda').value),
                        contacto: document.getElementById('editContacto').value
                    };
                }
                
                const { error } = await supabase
                    .from(currentEditTable)
                    .update(updateData)
                    .eq('id', currentEditId);
                
                if (error) throw error;
                
                showAlert('Registro actualizado exitosamente', 'success');
                closeModal();
                loadData();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al actualizar registro: ' + error.message, 'error');
            }
        }

        // 16. FUNCIONES PARA ELIMINAR REGISTROS
        function confirmarEliminacion(tabla, id) {
            currentEditId = id;
            currentEditTable = tabla;
            
            document.getElementById('confirmTitle').textContent = `Eliminar ${tabla}`;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        async function confirmDelete() {
            if (!currentEditId || !currentEditTable) return;
            
            try {
                const { error } = await supabase
                    .from(currentEditTable)
                    .delete()
                    .eq('id', currentEditId);
                
                if (error) throw error;
                
                showAlert('Registro eliminado exitosamente', 'success');
                closeModal();
                loadData();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al eliminar registro: ' + error.message, 'error');
            }
        }

        // 17. FUNCIONES PARA MANEJAR MODALES
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
            currentEditId = null;
            currentEditTable = null;
        }

        // 18. CERRAR MODAL AL HACER CLIC FUERA
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const confirmModal = document.getElementById('confirmModal');
            
            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
            if (event.target === confirmModal) {
                confirmModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>